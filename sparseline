#!/bin/env bash

declare _PS1
_PS1=$PS1

# get branch
function gitty()
{
    shopt -s extglob;
    shopt -s nullglob;
    :
    local path
    local dirbase
    local status
    local re
    local S
    local R
    local B
    local _H
    local H
    local T
    local X
    local C; # commit difference
    :
    local D=$'\uE0B0'
    :
    local _b_="\\033[48;5;"
    local _f_="\\033[38;5;"
    local __="\\[\\033[m"

    local r_="${_f_}219m"
    local _r="${_b_}219m"

    local b_="${_f_}21m"
    local _b="${_b_}21m"

    local g_="${_f_}40m"
    local _g="${_b_}40m"

    local k_="${_f_}232m"
    local _k="${_b_}232m"

    local w_="${_f_}231m"

    for path in {'.','..','../..'}/.git/HEAD
    do
        if [[ -r $path ]]
        then
            S="${g_}"$'\u25CF'
            [[ $1 -ne 0 ]] && S="${r_}×";

            dirbase=$(dirname "${path}")

            B=$(<"${path}")
            B="${B//*\//}"

            while read -r words
            do
                re=$"\\[remote \"(.*)\"\\]"
                [[ "${words}" =~ ${re} ]] && R="${BASH_REMATCH[1]}" && break
            done < "${dirbase:?}/config"
            R="${R:-remote?}" # give default value if otherwise undefined

            if [[ -r "${dirbase}/refs/heads/${B}" ]]; then
                _H=$(<"${dirbase}/refs/heads/${B}")
                H="${_H:0:7}"
                # C=$(( $( wc -l < "${dirbase}/logs/refs/heads/${B}" ) - $( wc -l < "${dirbase}/logs/refs/remotes/${R}/${B}" ) ))
                # if [[ $C -lt 0 ]]; then
                #     C=$"↓${C}"
                # elif [[ $C -gt 0 ]]; then
                #     C=$"↑${C}"
                # elif [[ $C -eq 0 ]]; then
                #     C=$'*'
                # fi
            else
                H=$''
                B="^${B:0:7}"
            fi

            for tag_path in ${dirbase}/refs/tags/*
            do
                X=$(<"${tag_path}")
                [[ $H == "${X:0:7}" ]] && \
                    T=$(basename "${tag_path}") && \
                    H="${T}"
            done
            status="$_k ${S} $__$_b$w_${R:+$R/}${B}${H:+#$H}${C}$__$b_${D}$__"

            break 2
        fi
    done

    export PS1="${status}${_PS1}"
    return 0
}
export PROMPT_COMMAND='gitty $?'
