#!/bin/env bash

declare _PS1
_PS1=$PS1

# get branch
function gitty()
{
    shopt -s extglob;
    shopt -s nullglob;
    :
    local dirbase
    local status
    local S
    local R
    local B
    local H
    local T
    local X


    for path in {'.','..','../..'}/.git/HEAD
    do
        if [[ -r $path ]]
        then
            S=$'○'; _SF=$'×';
            [[ $1 -ne 0 ]] && S="${_SF}"


            dirbase=$(dirname "${path}")

            B=$(<"${path}")
            B="${B//*\//}"


            while read -r words
            do
                str="${pre}${words}"
                pre="${words}"
                [[ $str =~ \"${B}\"\]remote\ =\ (.*) ]] && R="${BASH_REMATCH[1]}" && break
            done < "${dirbase:?}/config"

            if [[ -r "${dirbase}/refs/heads/${B}" ]]; then
                _H=$(<"${dirbase}/refs/heads/${B}")
                H="${_H:0:7}"
            else
                H=$''
                B="^${B:0:7}"
            fi

            for tag_path in ${dirbase}/refs/tags/*
            do
                X=$(<"${tag_path}")
                [[ $H == "${X:0:7}" ]] && \
                    T=$(basename "${tag_path}") && \
                    H="${T}"
            done

            status="« ${S} ${R:+$R/}${B}${H:+#$H} »"

            break
        fi
    done

    export PS1="${status}${_PS1}"
    return 0
}
export PROMPT_COMMAND='gitty $?'
